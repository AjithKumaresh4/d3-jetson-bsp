#!/bin/bash
# @configure_input@

set -e

print_usage()
{
    cat <<EOF
Usage kernel-deb CUSTOMER VERSION-NUMBER [package-revision]
EOF
}

##
# This uses the 'config' script that is bundled with the kernel to
# read the kernel configuration to see if an option is enabled (y, n,
# m, unknown, etc).
#
# @param 1 the kernel config option name
# @return prints 1 if enabled, 0 otherwise (including unknown options)
is_enabled()
{
    local enabled_result=$('@KERNEL_DIR@/scripts/config' \
                               --file '@LINUX_BUILD_PATH@/.config' -s "$1")

    if [ "$enabled_result" == 'y' ]; then
        echo 1
    else
        echo 0
    fi
}

# Leave this turned on!  It makes debugging much easier.
set -x

REVISION='1'
[[ ! "$1" ]] && { print_usage ; exit 1 ; }
[[ ! "$2" ]] && { print_usage ; exit 1 ; }
[[ "$3" ]] && REVISION="$3"
CUSTOMER="$1"
VERSION="$2"

# This is used by the D3 build_id kernel module. This value is also
# embedded in the device tree via the D3_DTCCPP_FLAGS (see below).
if [[ ! "$D3_JETSON_BSP_BUILDID" ]]; then
    export D3_JETSON_BSP_BUILDID="$(uuidgen -r)"
fi

# Handle D3_DTCCPP_FLAGS which are passed to the device tree compiler.
D3_IMX390_HDR_ENABLE=$(is_enabled 'd3_imx390_hdr_enable')
D3_OV10640_HDR_ENABLE=$(is_enabled 'd3_ov10640_hdr_enable')
export D3_DTCCPP_FLAGS="-DD3_JETSON_BSP_BUILDID='\\\"$D3_JETSON_BSP_BUILDID\\\"' -DD3_IMX390_HDR_ENABLE=$D3_IMX390_HDR_ENABLE -DD3_OV10640_HDR_ENABLE=$D3_OV10640_HDR_ENABLE"

export L4TDIR='@L4TDIR@'

OVERLAY=$(realpath 'debian-overlay/')

# Force the build-ids to be regenerated for dtb and kernel so that
# they match.
touch hardware/*/*.dts
touch kernel/d3/drivers/d3/build-id/*.c

# make-kpkg uses this evar but it also has the --jobs option. We set
# both.
export CONCURRENCY_LEVEL="$(grep -c '^processor' /proc/cpuinfo)"
if [[ "$MAX_CONCURRENCY_LEVEL" && "$CONCURRENCY_LEVEL" -gt "$MAX_CONCURRENCY_LEVEL" ]]; then
    CONCURRENCY_LEVEL="$MAX_CONCURRENCY_LEVEL"
fi

# Build IN-TREE.  `--config defconfig` tells make-kpkg to use `make defconfig`
# if it can't find a configuration.
# `CC=true` suppresses a meaningless warning; see
# https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=894965
pushd kernel/kernel-4.9
echo "Building with $CONCURRENCY_LEVEL processors in $(pwd)"
CC=true make-kpkg \
    --jobs "$CONCURRENCY_LEVEL" \
    --rootcmd fakeroot \
    --cross-compile aarch64-linux-gnu- \
    --arch arm64 \
    --revision "$REVISION" \
    --append-to-version "+$VERSION-$CUSTOMER" \
    --overlay-dir "$OVERLAY" \
    --config defconfig \
    kernel_image
popd
